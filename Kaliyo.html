<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kannada Letter Pictionary (petite-vue)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Basic styles for v-cloak to prevent flash of unstyled content */
        [v-cloak] { display: none; }
        /* Add styles for notification box if not already in style.css */
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            min-width: 200px;
            text-align: center;
        }
        .message-box.show { opacity: 1; }
        .message-info { background-color: #3b82f6; } /* blue-500 */
        .message-success { background-color: #10b981; } /* green-500 */
        .message-error { background-color: #ef4444; } /* red-500 */
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-full">

    <!-- Main App Container for petite-vue -->
    <div id="app-container" v-scope v-cloak class="flex flex-col h-full">

        <!-- Initial Setup View -->
        <div v-if="currentView === 'initial-setup'" class="w-full max-w-md mx-auto bg-white p-6 rounded-2xl shadow-lg text-center my-6 flex-shrink-0">
            <h1 class="text-3xl font-extrabold mb-4 text-green-600">ಕನ್ನಡ ಅಕ್ಷರ ಚಿತ್ರ</h1>
            <p class="mb-6 text-gray-600 font-semibold">Enter your name and create or join a room!</p>
            <div class="mb-4">
                <label for="player-name-input-pv" class="block text-sm font-bold text-gray-700 mb-2 text-left">Your Name:</label>
                <input type="text" id="player-name-input-pv" v-model="playerNameInput" class="w-full" placeholder="Enter your name">
            </div>
            <button @click="createRoom" class="w-full btn btn-secondary mb-3">Create New Room</button>
            <hr class="my-4 border-gray-200">
            <div class="mb-4">
                <label for="room-id-input-pv" class="block text-sm font-bold text-gray-700 mb-2 text-left">Room Code:</label>
                <input type="text" id="room-id-input-pv" v-model="roomIdInput" class="w-full" placeholder="Enter 4-digit code" maxlength="4">
            </div>
            <button @click="joinRoom" class="w-full btn btn-primary">Join Room</button>
            <p v-if="setupError" class="mt-3 text-red-500 text-sm font-semibold">{{ setupError.message }}</p>
        </div>

        <!-- Game Lobby View -->
        <div v-if="currentView === 'lobby'" class="w-full max-w-md mx-auto bg-white p-6 rounded-2xl shadow-lg text-center my-6 flex-shrink-0">
            <h2 class="text-2xl font-bold mb-3 text-gray-700">Room Lobby</h2>
            <p class="mb-2 text-gray-600">Room Code: <strong class="text-blue-600 text-lg font-mono">{{ room?.id || '----' }}</strong></p>
            <p class="mb-4 text-sm text-gray-500">Share this code with friends!</p>
            <div class="mb-4 text-left">
                <h3 class="font-bold text-gray-800 mb-2">Players ({{ room?.players?.length || 0 }}/8):</h3>
                <ul v-if="room?.players" class="list-none space-y-1 text-gray-700 font-semibold">
                     <li v-for="p in room.players" :key="p.id" :class="{ 'font-bold text-blue-600': p.id === room.hostId, 'italic': p.id === player?.id }">
                        {{ p.name }}
                        <span v-if="p.id === room.hostId">(Host)</span>
                        <span v-if="p.id === player?.id">(You)</span>
                    </li>
                </ul>
            </div>
            <div class="mb-4">
                <label for="lobby-score-goal-pv" class="block text-sm font-bold text-gray-700 mb-2 text-left">Team Score Goal:</label>
                <input type="number" id="lobby-score-goal-pv" v-model.number="lobbyScoreGoalInput" min="10" class="w-full" :disabled="!isHost">
            </div>
            <button @click="startGame" class="w-full btn btn-primary" :disabled="!canStartGame">
                {{ isHost ? 'Start Game' : 'Waiting for Host...' }}
            </button>
            <p class="mt-3 text-xs text-gray-500">Waiting for host ({{ room?.players?.find(p => p.id === room?.hostId)?.name || 'Host' }}) to start...</p>
            <button @click="leaveRoom" class="mt-4 text-sm text-red-600 hover:underline">Leave Room</button>
        </div>

        <!-- Main Game Area View -->
        <div v-if="currentView === 'game-area'" class="w-full h-full bg-[#f7faff] flex-grow flex flex-col overflow-hidden min-h-0">

            <div class="top-bar flex justify-between items-center flex-shrink-0">
                 <div class="text-sm font-semibold">
                     Drawing: <span class="active-player-indicator">{{ room?.players?.find(p => p.id === room?.gameState?.currentDrawerId)?.name || '...' }}</span>
                 </div>
                 <div class="text-sm font-semibold">
                     Time: <span>{{ timeLeft }}</span>s
                 </div>
                 <button @click="toggleScoreboard" :aria-expanded="isScoreboardVisible">
                     Scores {{ isScoreboardVisible ? '▲' : '▼' }}
                 </button>
            </div>

            <div class="flex-grow overflow-y-auto pb-4 min-h-0">

                <!-- Scoreboard Section (Collapsible) -->
                <div v-show="isScoreboardVisible" class="section-container collapsible-content">
                     <div class="section-header">
                        <h2 class="section-title">Scores & Goal</h2>
                     </div>
                     <div class="flex flex-col lg:flex-row flex-wrap justify-around items-start gap-4">
                        <div class="w-full lg:flex-1">
                            <h3 class="text-sm font-bold text-gray-600 mb-2">Player Scores:</h3>
                            <div class="space-y-1">
                                <div v-for="p in playersSorted" :key="p.id" class="player-score-item text-sm">
                                    <span class="font-semibold">{{ p.name }}:</span>
                                    <span class="text-green-700 font-bold">{{ p.score }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-full lg:w-auto bg-sky-100 p-4 rounded-xl text-center mt-2 lg:mt-0 border border-sky-200">
                            <p class="text-sm font-bold text-sky-700">Team Goal</p>
                            <p class="text-2xl font-extrabold text-sky-800 mt-1">
                                <span>{{ teamScore }}</span> / <span>{{ room?.settings?.scoreGoal || lobbyScoreGoalInput }}</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Drawing Section (Collapsible) -->
                <div class="section-container">
                    <div class="section-header">
                        <h2 class="section-title">Drawing Area</h2>
                        <button @click="toggleSection('drawing-content')" class="collapse-button" :aria-expanded="isDrawingVisible">
                            {{ isDrawingVisible ? '▲' : '▼' }}
                        </button>
                    </div>
                    <div v-show="isDrawingVisible" class="collapsible-content w-full flex flex-col items-center">
                        <div class="mb-3 text-center h-auto flex flex-col justify-center items-center p-3 rounded-xl bg-sky-50 w-full border border-sky-100">
                            <p class="text-sm font-bold text-sky-800">
                                {{ isDrawing ? "It's your turn to draw!" : `Waiting for ${room?.players?.find(p => p.id === room?.gameState?.currentDrawerId)?.name || '...'} to draw...` }}
                            </p>
                            <div v-if="isDrawing && currentWord" class="mt-1 text-center">
                                <span class="text-xs font-semibold text-gray-600">Draw this letter:</span><br/>
                                <span class="text-2xl font-bold text-blue-600 mr-1">{{ currentWord?.script }}</span>
                                <span class="text-lg font-semibold text-gray-700">({{ currentWord?.latin }})</span>
                            </div>
                            <!-- Removed show letter button for simplicity, word shown directly -->
                        </div>
                        <div class="w-full mb-4 relative">
                            <!-- Canvas element itself - petite-vue doesn't manage canvas drawing -->
                            <canvas id="drawing-canvas"></canvas>
                        </div>
                        <div v-if="isDrawing" class="flex flex-wrap justify-center items-center gap-4">
                            <label for="color-picker-pv" class="text-sm font-bold text-gray-600">Color:</label>
                            <input type="color" id="color-picker-pv" :value="currentColor" @input="handleColorChange" class="h-8 w-8 border-2 border-gray-200 rounded-lg cursor-pointer p-0.5">
                            <label for="brush-size-pv" class="text-sm font-bold text-gray-600">Size:</label>
                            <input type="range" id="brush-size-pv" min="1" max="20" :value="brushSize" @input="handleBrushSizeChange" class="cursor-pointer w-24 h-2 bg-gray-200 rounded-lg appearance-none accent-green-500">
                            <button @click="clearCanvasClick" class="btn btn-danger text-xs">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Guessing Section -->
                <div class="section-container">
                     <label for="guess-input-pv" class="block text-sm font-bold text-gray-700 mb-2">Your Guess:</label>
                     <div class="guess-input-container flex">
                        <input type="text" id="guess-input-pv" v-model="guessInput" @keypress.enter="sendGuess" :disabled="isDrawing" placeholder="Type Kannada or Latin..." class="flex-grow">
                        <button @click="sendGuess" class="btn btn-primary rounded-l-none" :disabled="isDrawing">Send</button>
                    </div>
                </div>

                <!-- Chat Section (Collapsible) -->
                <div class="section-container flex flex-col min-h-0">
                    <div class="section-header">
                        <h2 class="section-title">Chat</h2>
                         <button @click="toggleSection('chat-content')" class="collapse-button" :aria-expanded="isChatVisible">
                             {{ isChatVisible ? '▲' : '▼' }}
                         </button>
                    </div>
                    <div v-show="isChatVisible" class="collapsible-content flex flex-col flex-grow min-h-0">
                        <div class="p-2 overflow-y-auto flex-grow max-h-48 border border-gray-200 rounded-xl mb-2">
                             <div v-for="(msg, index) in messages" :key="index" :class="['chat-message mb-1 px-2 py-1 rounded text-sm', msg.type === 'system' ? 'text-gray-600 italic' : (msg.type === 'correct-guess' ? 'text-green-700 font-semibold bg-green-100' : (msg.type === 'error' ? 'text-red-700 font-semibold bg-red-100' : 'bg-gray-100'))]">
                                <strong v-if="msg.sender !== 'System'">{{ msg.sender }}:</strong>
                                <em v-if="msg.type === 'system'">{{ msg.message }}</em>
                                <span v-else>{{ msg.message }}</span>
                            </div>
                        </div>
                        <div class="flex">
                            <input type="text" id="chat-input-pv" v-model="chatInput" @keypress.enter="sendMessage" class="flex-grow border border-gray-300 rounded-l-lg p-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Type message...">
                            <!-- Removed dedicated send button, using Enter key -->
                        </div>
                    </div>
                </div>

            </div>

            <div class="mt-auto p-3 flex-shrink-0">
                <button @click="leaveRoom" class="btn btn-gray w-full">End Game / Leave</button>
            </div>

        </div>

        <!-- Notification Area -->
        <div v-if="notification" :class="['message-box', 'message-' + notification.type, 'show']">
            {{ notification.message }}
        </div>

    </div> <!-- End #app-container -->

    <!-- Load petite-vue -->
    <script src="https://unpkg.com/petite-vue" defer init></script>

    <!-- Load Main Application Script as Module -->
    <script type="module" src="src/main.js" defer></script>
</body>
</html>
